# Define the directories for the object and module files,
# the executable, and the executable name and path.
TOPDIR=../../..
include $(TOPDIR)/src/Mkinclude

OBJDIR = ./obj_temp
BINDIR = ../../bin
PROGRAM = $(BINDIR)/exe_msg

SOURCEDIR = ./

VPATH = \
${SOURCEDIR}

.SUFFIXES: .f90 .o

# Define the parallel (MPI or Hybrid)
PARA = MPI

ifeq ($(PARA),Hybrid)
	FFLAGS += -qopenmp
	CPPFLAGS = -DMPI_MSG -DICI
endif
ifeq ($(PARA),MPI)
	CPPFLAGS = -DMPI_MSG -DICI
endif

OBJECTS = \
$(OBJDIR)/Kind_module.o \
$(OBJDIR)/Constval_module.o \
$(OBJDIR)/Mpi_initfin.o \
$(OBJDIR)/Utility_module.o \
$(OBJDIR)/Mpi_utility.o \
$(OBJDIR)/Initial_module.o \
$(OBJDIR)/Mpi_read.o \
$(OBJDIR)/Read_module.o \
$(OBJDIR)/Open_file.o \
$(OBJDIR)/Read_input.o \
$(OBJDIR)/Mpi_set.o \
$(OBJDIR)/Check_condition.o \
$(OBJDIR)/Set_cell.o \
$(OBJDIR)/Make_cell.o \
$(OBJDIR)/Set_condition.o \
$(OBJDIR)/Assign_calculation.o \
$(OBJDIR)/Prep_calculation.o \
$(OBJDIR)/Assign_boundary.o \
$(OBJDIR)/Calc_boundary.o \
$(OBJDIR)/Set_boundary.o \
$(OBJDIR)/Calc_parameter.o \
$(OBJDIR)/Allocate_solution.o \
$(OBJDIR)/Mpi_solve.o \
$(OBJDIR)/Calc_function.o \
$(OBJDIR)/Make_amg_matrix.o \
$(OBJDIR)/Make_linearsystem.o \
$(OBJDIR)/Check_simulation.o \
$(OBJDIR)/Calc_simulation.o \
$(OBJDIR)/Linear_solution.o \
$(OBJDIR)/Allocate_output.o \
$(OBJDIR)/Mpi_write.o \
$(OBJDIR)/Calc_output.o \
$(OBJDIR)/Ici_module.o \
$(OBJDIR)/Write_module.o \
$(OBJDIR)/Time_module.o \
$(OBJDIR)/Nonlinear_solution.o \
$(OBJDIR)/Write_output.o \
$(OBJDIR)/Msg.o

# Define task functions

# Create the bin directory and compile and link the program
all: makebin | $(PROGRAM)

# Make the bin directory for the executable
makebin :
	mkdir -p $(BINDIR)

# Define the objects that make up the program
$(PROGRAM) : $(OBJECTS)
	-$(FC) $(FFLAGS) -o $@ $(OBJECTS) ${CPLLIB} ${CMMNLIB}

$(OBJDIR)/%.o : %.f90
	@mkdir -p $(@D)
	$(FC) $(FFLAGS) $(CPPFLAGS) -c $< -o $@ -I$(MODDIR) -I$(CMMNDIR)

# Clean the object and module files and the executable
.PHONY : clean
clean :
	-rm -rf $(OBJDIR)
	-rm -rf $(PROGRAM)

# Clean the object and module files
.PHONY : cleanobj
cleanobj :
	-rm -rf $(OBJDIR)
